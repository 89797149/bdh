<block name="content">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
         <title>买家中心</title>
         <link rel="stylesheet" href="__ROOT__/Apps/Home/View/default/css/common.css" />
         <link rel="stylesheet" href="__ROOT__/Apps/Home/View/default/css/user.css">
         <style>
         	.wst-odetal-box{padding:10px;text-align:center;background-color:#ffffff;}
         	.wst-tab{border-collapse: collapse; }
         	.wst-tab-cpt{text-align:left;height:30px;font-weight:bold;}
         	.wst-tab tr{height:30px;}
         	.wst-tab tr td{border:1px solid #eeeeee;}
         	.wst-td-title{width:100px;text-align:right;}
         	.wst-td-content{padding-left:6px;text-align:left;}
         	.wst-align-center{text-align:center;}
			
			.electricBtn{
				width: 55px;
				height: 30px;
				line-height: 32px;
				text-align: center;
				color: #fff;
				background: orange;
				border-radius: 5px;
				display: inline-block;
				    cursor: pointer;
					margin: 0 22px;
			}
			.countLayer{
			font-size:18px;
			color:orange;
			padding:0 5px;
			}
			
			.toCloseBtn{
				text-align:center;
			}
			.toCloseBtn span{
				text-align:center;
				background:orange;
				color:#fff;
				padding:5px 12px;
				cursor: pointer;
				border-radius:3px;
				
			}
			.wst-list tbody.layerlist tr.current{
				background:#409eff;
				color:#fff;
			}
			.layerDiv{
				display:none;
			}
			.dqlist{
				background: #e5eef7;
				padding:16px 10px 16px 30px;
				margin-bottom: 30px;
				color: #409eff;
				overflow: hidden;
			}
			.dqlist p{
				display:inline-block;
				margin-right: 10px;
				float:left;
				font-size: 16px;
			}
			.dqlist p:nth-child(5){
				margin-right: 0px;
			}
			.hasChoseElectricList .toChosebtn,.hasChoseElectricList .toAddElectricbtn{
				display:none;
				padding:6px 13px;
				background:#409eff;
				color:#fff;
				border-radius:3px;
				cursor:pointer;
			}
			.dqlistBtn{
				float:right;
				margin-right: 73px;
			}
						a.print{
				color: #409eff;
				background: #ecf5ff;
				border:1px solid #b3d8ff;
			}
			a.print:hover{
				color: #fff;
				background: #409eff;
			}
         </style>


		     <script src="__ROOT__/Public/js/jquery.min.js"></script>
		       	<script src="__PUBLIC__/plugins/formValidator/formValidator-4.1.3.js"></script>
     	<script src="__PUBLIC__/js/common.js"></script>
		<script src="__ROOT__/Public/js/think.js"></script> 
		<script src="__ROOT__/Public/plugins/layer/layer.min.js" type="text/javascript"></script>
		<script src="__ROOT__/Apps/Home/View/default/js/common.js"></script>
      	<script src="__ROOT__/Apps/Home/View/default/js/shopcom.js"></script>
      	<script src="__ROOT__/Apps/Home/View/default/js/head.js"></script>
		<script src="__ROOT__/Apps/Home/View/default/js/detail.js"></script> 
	
		<script>


		</script>
		
    </head>
    
    <body style="background-color:#f5f5f5;">
	
		<table class='wst-list layerDiv'>
           <thead>
             <tr>
               <th width="140" style="text-align:center;">ip</th> 
               <th width="100" style="text-align:center;">端口</th>
               <th style="text-align:center;">备注</th>
             </tr>
           </thead>
           <tbody class='layerlist'>

           </tbody>
        </table>

        <div style="text-align:center;">

        	<div class="wst-odetal-box">
        	<table cellspacing="0" cellpadding="0" class="wst-tab" width="920" style="border:1px solid #eeeeee;margin:0 auto;">
        		<caption class="wst-tab-cpt">订单信息</caption>
        		<tbody>
	        		<tr>
	        			<td class="wst-td-title">订单编号：</td>
	        			<td class="wst-td-content">{$orderInfo["order"]["orderNo"]}</td> 
	        		</tr>
	        		<tr>
	        			<td class="wst-td-title">支付方式：</td>
	        			<td class="wst-td-content"><if condition='$orderInfo["order"]["payType"]==0'>货到付款<else/>在线支付</if></td>
	        		</tr>
	        		<tr>
	        			<td class="wst-td-title">配送方式：</td>
	        			<td class="wst-td-content">
	        				<if condition='$orderInfo["order"]["isSelf"]==1'>
	        					自提
	        				<else/>
								<?php
									switch($orderInfo["order"]["deliverType"]){
										case 0:
											echo '商城配送';
										break;
										case 1:
											echo '门店配送';
										break;
										case 2:
											echo '达达配送';
										break;
										case 3:
											echo '蜂鸟配送';
										break;
										default:

									}

								?>
	        					
	        				</if>
	        			</td>
	        		</tr>
	        		<tr>
	        		    <td class="wst-td-title">买家留言：</td>
	        		    <td class="wst-td-content">{$orderInfo["order"]["orderRemarks"]}</td>
	        		</tr>
	        		<tr>
	        			<td class="wst-td-title">下单时间：</td>
	        			<td class="wst-td-content">{$orderInfo["order"]["createTime"]}</td>
	        		</tr>
        		</tbody>
        	</table>
        	</div>
        	<br/><br/>
     	
			<div class="hasChoseElectricList">
				
				
				<div class='dqlist'>
					<div class='dqlistP'>
					
						<p>当前选择的电子秤为：</p>
						<p><span>ip：</span><span class='ip'></span></p>
						<p><span>端口：</span><span class='port'></span></p>
						<p><span>备注：</span><span class='remark'></span></p>
					</div>
					<div class='dqlistBtn'>
						<p><span class="toChosebtn" onclick='toChose()'>选择电子秤</span></p>
						<p><span class="toAddElectricbtn" onclick="toAddElectric(this)" >添加电子秤</span></p>
					</div>
				</div>
			</div>
        	<div class="wst-odetal-box" style='padding-bottom:5px;'>
        	<table cellspacing="0" cellpadding="0" class="wst-tab" width="920" style="margin:0 auto;">
        		<caption class="wst-tab-cpt">商品信息</caption>
        		<tbody>
	        		<tr>
	        			<td width='*' class="wst-align-center">商品</td>
	        			<td width='120' class="wst-align-center">商品价格</td>
	        			<td width='120' class="wst-align-center">商品数量</td>
	        			<td width='150' class="wst-align-center">商品总金额</td>
						<td width='150' style="text-align: center;" class="zlfunctions">重量</td>
						<td width='200' class="wst-align-center" style="text-align:center;">操作</td>
	        		</tr>
	        		<volist name="orderInfo['goodsList']" id="goods" key='key1'>
	        		<tr>
	        			<td class="wst-align-center" style="vertical-align: middle;">  
		        			<div style="float:left;width:50px;">
			        			<a href="{:U('Home/Goods/getGoodsDetails/',array('goodsId'=>$goods['goodsId']))}" target="_blank">
			        			   <img style='margin:2px;' src="__ROOT__/{$goods['goodsThums']}" width='50' height='50'/>
			        			</a>
		        			</div> 
		        			<div style="float:left;width:360px;text-align: left;vertical-align: middle;margin-left: 8px;line-height: 20px;padding-top:15px;">
		        				<a href="{:U('Home/Goods/getGoodsDetails/',array('goodsId'=>$goods['goodsId']))}__ROOT__/index.php/Home/Goods/getGoodsDetails/?goodsId={$goods['goodsId']}" target="_blank">
		        				{$goods["goodsName"]}<if condition="$goods['goodsAttrName'] neq ''">【{$goods['goodsAttrName']}】</if>
		        				</a>
		        			</div>
		        			<div class="wst-clear"></div>
	        			</td>
	        			<td class="wst-align-center">￥{$goods["shopPrice"]}</td>  
	        			<td class="wst-align-center">{$goods["goodsNums"]}</td>
	        			<td class="wst-align-center">￥{$goods["shopPrice"]*$goods["goodsNums"]}</td>
						<td class="wst-align-center electricNumber" style="padding: 0 10px;">0g</td>
						<td class="wst-align-center electricTd" style="margin:0 20px;" onclick="toElectronic(this)" name='{$goods["goodsName"]}' count='{$goods["goodsNums"]}' goodid='{$goods["goodsId"]}'>
						<span class="electricBtn">称重</span> 
						</td>

	        		</tr>
	        		</volist>
        		</tbody>
        	</table>
			<div onclick="checkedElectronic({$orderInfo['order']['orderId']})" style="text-align: center;padding: 130px 0 40px;">
				<a style="text-align: center;padding: 9px 15px;color: #fff;background: #ff8000;border-radius: 4px;cursor: pointer;">发货配送</a>
			</div>
        	</div>
        </div>

	<script src="__ROOT__/Apps/Home/View/default/js/vue.js" type="text/javascript" charset="utf-8"></script>
    <script src="__ROOT__/Apps/Home/View/default/js/vue-resource.js" type="text/javascript" charset="utf-8"></script>
    <script src="__ROOT__/Apps/Home/View/default/js/require.js" type="text/javascript" charset="utf-8"></script>
    <script src="__ROOT__/Apps/Home/View/default/js/SQLite.js" type="text/javascript" charset="utf-8"></script>
	<!--<script src="__ROOT__/Apps/Home/View/default/js/shopcom.js"></script>!-->
<script type="text/javascript">
var WSTs = ThinkPHP = window.Think = {
        "ROOT"   : "__ROOT__",
        "APP"    : "__APP__",
        "PUBLIC" : "__PUBLIC__",
        "DEEP"   : "{:C('URL_PATHINFO_DEPR')}",
        "MODEL"  : ["{:C('URL_MODEL')}", "{:C('URL_CASE_INSENSITIVE')}", "{:C('URL_HTML_SUFFIX')}"],
        "VAR"    : ["{:C('VAR_MODULE')}", "{:C('VAR_CONTROLLER')}", "{:C('VAR_ACTION')}"],
        "DOMAIN" : "{:WSTDomain()}",
        "CITY_ID" : "{$currArea['areaId']}",
        "CITY_NAME" : "{$currArea['areaName']}",
        "DEFAULT_IMG": "{:WSTDomain()}/{$CONF['goodsImg']}",
        "MALL_NAME" : "{$CONF['mallName']}",
        "SMS_VERFY"  : "{$CONF['smsVerfy']}",
        "PHONE_VERFY"  : "{$CONF['phoneVerfy']}",
        "IS_LOGIN" :"{$WST_IS_LOGIN}"
}
    $(function() {
    	$('.lazyImg').lazyload({ effect: "fadeIn",failurelimit : 10,threshold: 200,placeholder:WST.DEFAULT_IMG});
    });
</script>
		<script src="__PUBLIC__/js/think.js"></script> 
		<script>

		//判断是否有电子秤列表 
					M('shopElectric').select().then(t=>{
						console.log("抽象层获取数据列表11:")
						console.log(t)
						//alert(t.length)
						if(t.length>1){
							
							$('.dqlist .dqlistP').hide();

							$('.hasChoseElectricList .toChosebtn').show();
							//parent.location.href='Home/Goods/ElectronicScaleList';//执行操作
							//location.href= Think.U('Home/Goods/ElectronicScaleList');
							
							var atips =WST.msg('请选择一个再进行商品称重', {icon: 6});
							//var layerTips =WST.msg('请选择一个再进行商品称重', {icon: 6});
							//$(".layerlist").show();

							//list 列表渲染
							
							var dialogs = "";
			
							for(var j=0;j<t.length;j++){
							dialogs+="<tr class='titles' id='"+j+"'>";
								dialogs+="<td class='ip' style='text-align:center;'>";
									dialogs+="<span class='text-black attrIp'>"+t[j].ip+"</span>";
								dialogs+="</td>";
								dialogs+="<td class='port' style='text-align:center;'>";
									dialogs+="<span class='text-black attrPort'>"+t[j].port+"</span>";
								dialogs+="</td>";
								dialogs+="<td class='remark' style='text-align:center;'>";
									dialogs+="<span class='text-black attrRemark'>"+t[j].remark+"</span>";
								dialogs+="</td>";

							dialogs+="</tr>";
								

							}
							$(".layerlist").append(dialogs);
							$(".layerlist tr").eq(0).addClass("current");
							for(var i=0;i<$(".layerlist tr").length;i++){
								
								//$(".layerlist tr").eq(i).removeClass("current");
								$(".layerlist tr").eq(i).click(function(){

									//console.log($(this).)
									$(this).addClass("current").siblings().removeClass("current");
									

								})
							}
							
						}else if(t.length==1){
							//$(".hasChoseElectricList").show();
							//$(".hasChoseElectricList")
							$('.dqlist .ip').html(t[0].ip);
							$('.dqlist .port').html(t[0].port);

							$('.dqlist .remark').html(t[0].remark);
							
							
 						}else if(t.length==0){
							$(".toAddElectricbtn").show();
							var atips =WST.msg('请添加一个电子秤配置', {icon: 6});
							
					
						}
					})
		
			function toAddElectric(){
					var index=parent.layer.getFrameIndex(window.name);
					parent.location.href=Think.U('Home/Goods/ElectronicScaleList');//执行操作
					parent.layer.close(index);

			}
			//点击称重
			function toChose(){
			
				//判断是否有电子秤列表 
				M('shopElectric').select().then(t=>{
					console.log("抽象层获取数据列表11:")
					console.log(t)
					
					if(t.length>1){
						
						//页面层
						$(".layerDiv").show();
						var w =layer.open({
						  type: 1,
						  title:"请选择一个再进行商品称重：",
						  skin: 'layui-layer-rim', //加上边框
						  area: ['820px', '240px'], //宽高
						  content:$('.layerDiv'),
						  btn: ['确定', '取消'],
							yes: function(index, layero){
								layer.msg('选择完成', {icon: 1});

								
								layer.close(w);
								
								$(".dqlist .ip").html($(".layerlist tr.current .attrIp").html());
								$(".dqlist .port").html($(".layerlist tr.current .attrPort").html());
								$(".dqlist .remark").html($(".layerlist tr.current .attrRemark").html());
								
								$('.dqlist .dqlistP').show();
								
								//$(".layerlist tr").eq(0).removeClass("current");
							}
						  
						});
						
					}
				})
			}

			function toElectronic(e){

			

				if(typeof(isClient)=='undefined'){
	
					WST.msg('请到客户端进行称重', {icon: 6});	
					
				}else{

					//if($(e).attr('hasChosed')=='1'){
					

						
					if($(".dqlist .ip").html()!==""){
			


						//alert($(".dqlist .ip").html())
						getElectScal({
							//'param':['192.168.0.115',8080]
							'param':[$(".dqlist .ip").html(),Number($(".dqlist .port").html())] 
						},function(e){
							console.log('调用状态2221：');
							console.log(e);
						})
						localStorage.elecNumber=-1;
					
						window.onElectScalRes=function(e){
							console.log('电子秤111222回调：'); 
							console.log(e);
				
							localStorage.elecNumber=e; 
						}
						
						//监听电子秤数据


						var findHtml = $(e).parent(); 
						
						var onTimeS = setInterval(function(){
							//console.log('定时器：')
							//console.log(localStorage.elecNumber)
							if(localStorage.elecNumber !== '-1'){  
								
								layer.close(ll);
								var a =WST.msg('正在称重，请稍候', {icon: 6});
								console.log(localStorage.elecNumber)	
								findHtml.find(".electricNumber").html(localStorage.elecNumber+'g');
					
								findHtml.find(".electricTd").attr("hasEleced","1");
								localStorage.elecNumber=-1;	
								clearInterval(onTimeS)							
							}else if(localStorage.elecNumber == '-1'){ 
								var goodname=$(e).attr('name');
								var goodcount=$(e).attr('count');
								
								//var ll = layer.load('请将'+goodname+'放到电子秤上面！'); 
								var ll =WST.msg('请将'+'<span class="countLayer">'+goodcount+'件</span>'+goodname+'放到电子秤上面！<p class="toCloseBtn"><span>关闭</span></p>', {icon: 5});
								layer.close(a);
								$(".toCloseBtn").click(function(){
									
									layer.close(ll);
									 
									clearInterval(onTimeS); 
								})
							}
							
						},1000);
					
					}else{
						var ll =WST.msg('请选择一个电子秤再进行商品称重',{icon: 6});
					}
				}	

			}
			

			//过秤选择好之后发货配送

			function checkedElectronic(id){ 
			
				var arrs=[],arrs2=[];
				var jsObj =''; 
				var goodweight;
				for(var i=0;i<$(".electricTd").length;i++){
					//console.log("heheheh")
					//console.log($(".electricTd").eq(i).attr("hasEleced"))
					if($(".electricTd").eq(i).attr("hasEleced")=="1"){
						$(".electricTd").eq(i).find("span").css({"background":"orange"});
						
						arrs.push($(".electricTd").eq(i).find("span").attr("hasEleced"));
						
						var goodid=$(".electricTd").eq(i).attr("goodid");
						//console.log("goodid打印======")
						//console.log(goodid)
						//console.log("value打印")
						//console.log($(".electricNumber").eq(i).html());
						if($(".electricNumber").eq(i).html()!==undefined){
							//jsObj.goodsId=goodid;
							//jsObj.goodWeight=$(".electricNumber").eq(i).html(); 
							//ids += fID + ",";
							
							goodweight=$(".electricNumber").eq(i).html();
							jsObj+='goodsId'+'='+goodid+'@'+'goodWeight'+'='+goodweight+'#';
							//arrs2.push(jsObj);
							
						}
						
					}else{
						$(".electricTd").eq(i).find("span").css({"background":"red"});
						
					}
				}
				
				
				//console.log(JSON.stringify(jsObj))
				//console.log(arrs2.toString())
				
				//var arr3=[];
				//for(var i=0;i<arr2.length;i++){
				//	console.log(arr2)
				//	if(arr2[i]!==undefined){
				//		arr3.push(arr2[i])
				//	}
				//}
				
				if(arrs.length==$(".electricTd").length){ 
					
				//条件判断-全部过秤选中则发货配送

					jsObj=jsObj.substring(0,jsObj.length-1);
				
					console.log(jsObj)
					if($(".electricNumber").html()=='g' || $(".electricNumber").html()=='0g'){
						//alert('请选择正确的电子秤并称重')
						var ll =WST.msg('请选择正确的电子秤并称重', {icon: 5});
					}else{

					layer.confirm('确定发货吗？',{icon: 3, title:'系统提示'}, function(tips){
						
						var ll =WST.msg('数据处理中，请稍候...'); 

						$.post(Think.U('Home/Orders/shopOrderDelivery'),{orderId:id,weightGJson:jsObj},function(data){
							layer.close(ll);
							layer.close(tips);
							var json = WST.toJson(data);
							console.log("称重打印11111")
							console.log(json)
							if(json.status>0){
								WST.msg('操作成功!', {icon: 6},function(){
								
									var index=parent.layer.getFrameIndex(window.name);
									window.parent.location.reload();
									parent.layer.close(index);
								});
							}else if(json.status==-1){
								WST.msg('操作失败，订单状态已发生改变，请刷新后再重试 !', {icon: 5});
							}else{
								WST.msg('操作失败，请与商城管理员联系 !', {icon: 5});
							}
					   });
					});
					}
				}else{
					//否则提示用户去选择未选中的过秤商品 
					var ll =WST.msg('请称重...');
					
				}
				
			}

//测试称重数据===================================================================
		</script>
    </body>

</html>
</block>